<script lang="ts" setup>
import { onMounted, ref } from 'vue'

// 响应式数据
const showTextArea = ref(false)
const newWords = ref('')
const words = ref<{ word: string, translation: string }[]>([])

// 从localStorage加载数据
function loadWords() {
  const savedWords = localStorage.getItem('words')
  if (savedWords) {
    words.value = JSON.parse(savedWords)
  }
}

// 保存数据到localStorage
function saveWords() {
  localStorage.setItem('words', JSON.stringify(words.value))
}

// 添加单词
// 匹配并保存对应单词和意思到浏览器中
function addWord() {
  let fore = ''
  let rear = ''
  const trimmedWords = newWords.value
    .split('\n')
    .map(word => word.trim())
    .filter(word => word.length > 0)

  trimmedWords.forEach((word) => {
    if (!words.value.some(item => item.word === word)) {
      // eslint-disable-next-line regexp/no-super-linear-backtracking
      const match = word.match(/^([a-z\s;,]+)([^a-z].*)$/i)
      if (match) {
        fore = match[1].trim()
        rear = match[2].trim()
      }

      words.value.push({ word: fore, translation: rear })
    }
  })

  newWords.value = ''
  saveWords()
}

// 删除localStorage中的所有单词
function clearList() {
  // eslint-disable-next-line no-alert
  if (confirm('确定要清空所有单词吗？')) {
    words.value = []
    localStorage.removeItem('words')
  }
}

// 删除单条单词
function deleteWord(word: string) {
  words.value = words.value.filter(item => item.word !== word)
  saveWords()
}

// 切换显示文本区域
function toggleTextArea() {
  showTextArea.value = !showTextArea.value
}

// 组件挂载时加载数据
onMounted(() => {
  loadWords()
})
</script>

<template>
  <div
    flex="~ items-center"
    fixed right-36 top-4 z-panel-nav border border-base rounded-full shadow bg-glass
  >
    <div
      h-10
      w-10 rounded-full hover:bg-active op50 hover:op100 flex="~ items-center justify-center"
      @click="toggleTextArea"
    >
      <div v-if="showTextArea" i-carbon-view-filled text-xl />
      <div v-else i-carbon-view-off-filled text-xl />
    </div><div
      h-10
      w-10
      rounded-full hover:bg-active op50 hover:op100 flex="~ items-center justify-center" @click="clearList"
    >
      <div i-carbon-close-outline text-xl />
    </div>
  </div>
  <div mt-2 p-2>
    <div
      v-if="showTextArea"
      class="mb-4 flex items-center justify-center"
    >
      <textarea
        v-model="newWords"
        placeholder="添加单词"
        class="h-screen-sm w-screen-md border-2 rounded-xl outline-transparent outline dark:border-gray-7 bg-base"
      />
      <button
        class="ml-2 rounded-xl bg-#42B883 px-4 py-2 text-white hover:bg-#345B4C"
        @click="addWord"
      >
        提交
      </button>
    </div>
    <div
      v-for="item in words" :key="item.word"
      class="flex items-center justify-center"
    >
      <div mb-2 w-2xl flex justify-between border rounded-xl p-2 dark:border-gray-7 bg-base>
        <div>
          <span mr-2 font-size-6 font-bold>{{ item.word }}</span>
          <span font-size-6 font-bold class="hover-show">{{ item.translation }}</span>
        </div>
        <div
          ml-2 h-10 w-10 rounded-full hover:bg-active op50 hover:op100 flex="~ items-center justify-center"
          @click="deleteWord(item.word)"
        >
          <div i-carbon-close-outline text-xl />
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
/* 正常情况高斯模糊背景 */
.hover-show {
  filter: blur(0.7rem);
  transition: filter 0.3s ease;
}
.hover-show:hover {
  filter: blur(0);
}
</style>
